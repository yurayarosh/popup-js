"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _createClass(t,e,o){return e&&_defineProperties(t.prototype,e),o&&_defineProperties(t,o),t}function _defineProperty(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}function ownKeys(e,t){var o,n=Object.keys(e);return Object.getOwnPropertySymbols&&(o=Object.getOwnPropertySymbols(e),t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,o)),n}function _objectSpread2(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(o),!0).forEach(function(t){_defineProperty(e,t,o[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):ownKeys(Object(o)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))})}return e}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_unsupportedIterableToArray(t)||_nonIterableSpread()}function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}function _iterableToArray(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var o=Object.prototype.toString.call(t).slice(8,-1);return"Object"===o&&t.constructor&&(o=t.constructor.name),"Map"===o||"Set"===o?Array.from(t):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var o=0,n=new Array(e);o<e;o++)n[o]=t[o];return n}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var POPUP$1="popup",OPEN="js-popup-open",TARGET="js-popup",CLOSE="js-popup-close",IS_ACTIVE="active",BTN_IN_POPUP_OPEN="js-btn-in-popup-open",HASH="#",BEMblock$1=function(e,o){return{name:o,block:e,addMod:function(t){e.classList.add("".concat(o,"--").concat(t))},toggleMod:function(t){e.classList.toggle("".concat(o,"--").concat(t))},removeMod:function(t){e.classList.remove("".concat(o,"--").concat(t))},containsMod:function(t){return e.classList.contains("".concat(o,"--").concat(t))}}};function preventScroll(){var t=window.innerWidth-document.documentElement.clientWidth;document.body.style.overflow="hidden",0<t&&(document.body.style.marginRight="".concat(t,"px"))}function allowScroll(){document.body.style.overflow="",document.body.style.marginRight=""}function closeAll(){var e=this;this.openPopups.length&&(this.openPopups.forEach(function(t){BEMblock(t,POPUP).removeMod(IS_ACTIVE)}),this.options.toggleBtnClass.toggle&&0<this.btns.length&&this.btns.forEach(function(t){BEMblock(t,e.options.toggleBtnClass.name).removeMod(IS_ACTIVE)}),0<this.hashStart&&this.removeUrl(),this.resetElements(),this.options.preventScroll&&allowScroll())}function resetElements(){this.btn=null,this.popup=null,this.closeTrigger=null,this.observedPopups=[],this.options.shouldChangeUrl=!1}function pushUrl(){var t="".concat(window.location.href).concat(this.name);window.history.pushState({},"",t)}function removeUrl(){var t=window.location.href.slice(0,this.hashStart);window.history.pushState({},"",t),this.href=""}function handlePopState(){-1===this.hashStart&&(this.closeTrigger=this.openPopups[this.openPopups.length-1],this.closePopup()),0<this.hashStart&&(this.href||this.btn||(this.href=window.location.href.slice(this.hashStart)),this.openPopup())}function handleEscClick(){this.openPopups.length&&(this.closeTrigger=this.openPopups[this.openPopups.length-1],this.closePopup())}function handleBtnClick(t){var e,o=t.target.closest(".".concat(CLOSE));this.options.closeOnOverlayClick?(e=t.target.classList&&t.target.classList.contains(TARGET)?t.target:null,this.closeTrigger=o||e):this.closeTrigger=o,this.closeTrigger&&(t.preventDefault(),this.closePopup())}function handleOpen(t){this.btn=t.target.closest(".".concat(OPEN)),this.btn&&(t.target.closest(".".concat(BTN_IN_POPUP_OPEN))||(this.openPopup(),t.preventDefault()))}function handleClose(t){this.options.escapeHandler&&"Escape"===t.code&&this.handleEscClick(t),"click"===t.type&&this.handleBtnClick(t)}function openPopup(){var e=this;this.name=this.btn?this.btn.dataset.popupTarget||this.href||this.btn.getAttribute("href"):this.href,-1<window.location.href.indexOf(HASH)?this.options.shouldChangeUrl=!1:0===this.name.indexOf(HASH)?(this.options.shouldChangeUrl=!0,this.href=this.name):(this.options.shouldChangeUrl=!1,this.href&&this.removeUrl()),this.popup=0===this.name.indexOf(HASH)?document.getElementById(this.name.slice(1)):document.querySelector(".".concat(TARGET,'[data-popup="').concat(this.name,'"]')),this.popup&&(this.name&&this.options.shouldChangeUrl&&this.pushUrl(),BEMblock$1(this.popup,POPUP$1).addMod(IS_ACTIVE),this.options.toggleBtnClass.toggle&&BEMblock$1(this.btn,this.options.toggleBtnClass.name).addMod(IS_ACTIVE),this.options.preventScroll&&preventScroll(),this.onOpen&&this.onOpen(),this.observedPopups.filter(function(t){return t===e.popup})[0]||(this.observer.observe(this.popup,{attributes:!0,attributeFilter:["class"],attributeOldValue:!0}),this.observedPopups.push(this.popup)))}function closePopup(){this.href&&0<this.hashStart&&this.removeUrl(),this.popup=this.closeTrigger.closest(".".concat(TARGET)),this.name=this.popup.dataset.popup,this.btn=document.querySelector(".".concat(OPEN,'[data-popup-target="').concat(this.name,'"]')),BEMblock$1(this.popup,POPUP$1).removeMod(IS_ACTIVE),this.options.toggleBtnClass.toggle&&BEMblock$1(this.btn,this.options.preventScroll.name).removeMod(IS_ACTIVE),this.options.preventScroll&&!this.openPopups.length&&allowScroll(),this.resetElements()}function openTarget(t){this.href=t.id?"#".concat(t.id):null,this.btn=this.href?document.querySelector(".".concat(OPEN,'[href="').concat(this.href,'"]')):document.querySelector(".".concat(OPEN,'[data-popup-target="').concat(t.dataset.popup,'"]')),this.openPopup()}function closeTarget(t){this.closeTrigger=t,this.closePopup()}function handleMutation(t){var e=this;t.forEach(function(t){0<t.oldValue.indexOf("".concat(POPUP$1,"--").concat(IS_ACTIVE))&&e.onClose&&e.onClose()})}var defaultOptions={preventScroll:!0,escapeHandler:!0,closeOnOverlayClick:!0,toggleBtnClass:!1},Popup=function(){function e(t){_classCallCheck(this,e),this.options=_objectSpread2(_objectSpread2({},defaultOptions),t),this.closeAll=closeAll.bind(this),this.resetElements=resetElements.bind(this),this.pushUrl=pushUrl.bind(this),this.removeUrl=removeUrl.bind(this),this.handlePopState=handlePopState.bind(this),this.handleEscClick=handleEscClick.bind(this),this.handleBtnClick=handleBtnClick.bind(this),this.handleOpen=handleOpen.bind(this),this.handleClose=handleClose.bind(this),this.openPopup=openPopup.bind(this),this.closePopup=closePopup.bind(this),this.openTarget=openTarget.bind(this),this.closeTarget=closeTarget.bind(this),this.handleMutation=handleMutation.bind(this),this.open=this.handleOpen.bind(this),this.close=this.handleClose.bind(this),this.observer=new MutationObserver(this.handleMutation.bind(this)),this.onPopstate=this.handlePopState.bind(this),this.btn=null,this.popup=null,this.closeTrigger=null,this.observedPopups=[]}return _createClass(e,[{key:"_addListeners",value:function(){document.addEventListener("click",this.open),document.addEventListener("click",this.close),document.addEventListener("keydown",this.close),window.addEventListener("popstate",this.onPopstate)}},{key:"_removeListeners",value:function(){document.removeEventListener("click",this.open),document.removeEventListener("click",this.close),document.removeEventListener("keydown",this.close),window.removeEventListener("popstate",this.onPopstate)}},{key:"_removeOpenClassNames",value:function(){this.popups.forEach(function(t){BEMblock$1(t,POPUP$1).removeMod(IS_ACTIVE)}),this.options.preventScroll&&preventScroll()}},{key:"_onLoad",value:function(){0<this.hashStart&&(this.href=window.location.href.slice(this.hashStart),this.openPopup())}},{key:"init",value:function(){this._addListeners(),this._onLoad()}},{key:"destroy",value:function(){this._removeListeners(),this._removeOpenClassNames(),this.observer.disconnect()}},{key:"popups",get:function(){return _toConsumableArray(document.querySelectorAll(".".concat(TARGET)))}},{key:"btns",get:function(){return _toConsumableArray(document.querySelectorAll(".".concat(OPEN)))}},{key:"openPopups",get:function(){return this.popups.filter(function(t){return BEMblock$1(t,POPUP$1).containsMod(IS_ACTIVE)})}},{key:"closeBtns",get:function(){return this.popup?_toConsumableArray(this.popup.querySelectorAll(".".concat(CLOSE))):null}},{key:"hashStart",get:function(){return window.location.href.indexOf(HASH)}}]),e}();module.exports=Popup;
